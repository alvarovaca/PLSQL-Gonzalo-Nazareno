create or replace procedure ejercicio2(p_asignatura asignaturas.nombre%type);
is
	cursor c_notas
	is
	select nombre, nota		
	from notas n, alumnos a
	where n.dni= a.dni
	and cod = (select cod
			   from asignaturas
			   where nombre=p_asignatura);
	cont_sus number:=0;
	cont_apr number:=0;
	cont_not number:=0;
	cont_sob number:=0;
	v_notamax notas.nota%type:=-1;
	v_notamin notas.nota%type:=11;
	v_alumnomax alumnos.nombre%type:='';
	v_alumnomin alumnos.nombre%type:='';
begin
	ComprobarExcepcionesej2(p_asignatura);
	MostrarCabeceraInforme(p_asignatura);
	for v_notas in c_notas loop
		MostrarAlumno(v_notas.nombre, v_notas.nota);
		ActualizarContadores(v_notas.nota, cont_sus, cont_apr, cont_nob, cont_sob);
		ActualizarMaxyMin(v_notas.nombre, v_notas.nota, v_notamax, v_alumnomax, v_notamin, v_alumnomin);
	end loop;	
	MostrarResultados(cont_sus, cont_apr, cont_nob, cont_sob, v_notamax, v_alumnomax, v_notamin, v_alumnomin);
end ejercicio2;

create or replace procedure ComprobarExcepcionesej2(p_asignatura asignaturas.nombre%type)
is
	ComprobarExistenciaTablas;
	ComprobarExistenciaAsignatura(p_asignatura);
end ComprobarExcepcionesej2;

create or replace procedure ComprobarExistenciaTablas
is
	cont_alumnos number;
	cont_asignaturas number;
	cont_notas number;
begin
	select count(*) into cont_alumnos from alumnos;
	if cont_alumnos=0 then
		raise_application_error(-20001,'Tabla Alumnos vacía');
	end if;
	select count(*) into cont_asignaturas from asignaturas;
	if cont_asignaturas=0 then
		raise_application_error(-20002,'Tabla Asignaturas vacía');
	end if;
	select count(*) into cont_notas from notas;
	if cont_notas=0 then
		raise_application_error(-20003,'Tabla Notas vacía');
	end if;
end ComprobarExistenciaTablas;

create or replace procedure ComprobarExistenciaAsignatura(p_asig asignaturas.nombre%type)
is
	ind_existencia number:=0;
begin
	select count(*) into ind_existencia
	from asignaturas
	where nombre=p_asig;
	if ind_existencia=0 then 
		raise_application_error(-20004,'La asignatura no existe');
	end if;	
end ComprobarExistenciaAsignatura;

create or replace procedure MostrarCabeceraInforme(p_asig asignaturas.nombre%type)
is
	v_subrayado varchar2(80):='_';
begin
	dbms_output.put_line('Informe de notas de la asignatura '||p_asignatura);
	dbms_output.put_line(rpad(v_subrayado,34+length(p_asignatura),'_'));
	dbms_output.put_line(chr(13));
end MostrarCabeceraInforme;

create or replace procedure MostrarAlumno(p_nom alumnos.nombre%type, p_not notas.nota%type)
is
begin
	dbms_output.put_line(chr(9)||rpad(p_nom,30,'.')||p_not);
end MostrarAlumno;

create or replace procedure ActualizarContadores(p_nota notas.nota%type,
												 cont_sus in out number,
												 cont_apr in out number,
												 cont_nob in out number,
												 cont_sob in out number)
is
begin
	case
		when p_nota<5 then
			cont_sus:=cont_sus+1;
		when p_nota>=5 and p_nota<7 then
			cont_apr:=cont_apr+1;
		when p_nota>=7 and p_nota<9 then
			cont_not:=cont_not+1;
		when p_nota>=9 then		
			cont_sob:=cont_sob+1;
	end case;
end ActualizarContadores;

create or replace procedure ActualizarMaxyMin(p_nombre alumnos.nombre%type,
											  p_nota notas.nota%type,
											  v_notamax in out notas.nota%type,
											  v_alumnomax in out alumnos.nombre%type,
											  v_notamin in out notas.nota%type,
				 							  v_alumnomin in out alumnos.nombre%type)
is
begin
	if p_nota>v_notamax then
		v_notamax:=p_nota;
		v_alumnomax:=p_nombre;
	end if;
	if p_nota<v_notamin then
		v_notamin:=p_nota;
		v_alumnomin:=p_nombre;
	end if;
end ActualizarMaxyMin;

create or replace procedure MostrarResultados(cont_sus NUMBER,
											  cont_apr NUMBER,
											  cont_nob NUMBER,
											  cont_sob NUMBER,
											  v_notamax notas.nota%type,
											  v_alumnomax alumnos.nombre%type,
					 						  v_notamin notas.nota%type,
											  v_alumnomin alumnos.nombre%type)
is
begin
	dbms_output.put_line('El número de suspensos es: '||cont_sus);
	dbms_output.put_line('El número de aprobados es: '||cont_apr);
	dbms_output.put_line('El número de notables es: '||cont_not);
	dbms_output.put_line('El número de sobresalientes es: '||cont_sob);
	dbms_output.put_line('El alumno con la nota más alta es '||v_alumnomax||', que tiene un '||v_notamax);
	dbms_output.put_line('El alumno con la nota más baja es '||v_alumnomin||', que tiene un '||v_notamin);
end MostrarResultados;
